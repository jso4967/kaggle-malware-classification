import ujson
from collections import Counter
import pandas as pd
import config
import sys

MAX_NGRAMS_FILE = 'max_bytes_ngrams_top_%s.txt'
DATA_FILE = 'bytes_ngrams_2_%s.txt'
OUTPUT_FILE = 'bytes_ngrams_2_top_%s_%s.pd'

def key_to_str(key):
    if isinstance(key, list): 
        key = "%s_%s" % tuple(key)
    return key

# sys.argv[1] 값이 train인 경우
def calc_top_n_ngrams(env, n):
    counter = Counter()

    fname = config.locate_file(env, DATA_FILE % env)
    with open(fname) as f:
        for line in f:
            record = ujson.loads(line.strip()) #파일에서 한줄씩 읽어서 json의 오브젝트로 저장
            for k, value in record:
                if k == 'key':
                    continue

                k = key_to_str(k) #json 오브젝트의 키 값이 'key'가 아닌 경우, key 값이 tuple 형이기에 문자열로 변환하여 저장한다.
                counter[k] = counter[k] + 1 # 각 키 값을 항목이 있을 때 마다 1씩 늘려준다. 즉, json의 각 오브젝트의 수를 센다.
    counter = counter.items() # ?  counter변수를 Counter 객체에서 튜플 형식으로 변환한다.
    counter.sort(key=lambda v: v[1], reverse=True) #튜플 형식의 counter를 값에 대한 역순으로 정렬한다.
    counter = dict(counter[:n]) # 나온 튜플 값들 중에 상위 n개의 오브젝트만 모아서 다시 counter에 할당한다.

    fname = config.locate_file(env, MAX_NGRAMS_FILE % n)
    with open(fname, 'w') as f:
        f.write(ujson.dumps(counter)) # 정리된 오브젝트를 다시 json 형식으로 변환하여 파일에 입력한다.
        print 'Saved to', fname

def load_max_keys(env, n):
    fname = config.locate_file(env, MAX_NGRAMS_FILE % n)
    with open(fname) as f:
        return ujson.loads(''.join(f.readlines()))

def build_model(env, n):
    max_keys = load_max_keys(env, n) # env를 오브젝트 형식 그리고 각 라인 별로 띄어쓰기로 구분해서 max_keys에 저장한다.
    max_keys = max_keys.keys() 
    max_keys.sort()

    features = []
    fname = config.locate_file(env, DATA_FILE % env)
    with open(fname) as f:
        for line in f:
            record = ujson.loads(line.strip()) #파일에서 오브젝트 형식으로 한 라인씩 앞뒤 공백을 제거하고, record 변수에 저장한다.
            record = dict([(key_to_str(k), v) for k, v in record])

            current = [record['key']] + [record.get(k, 0) for k in max_keys]
            features.append(current)

    features = pd.DataFrame(features)
    fname = config.locate_file(env, OUTPUT_FILE % (n, env))
    features.to_csv(fname)
    print 'Saved to', fname


if __name__ == '__main__':
    env = sys.argv[1]

    n = 1000
    if config.conf[env]['calc_stats']:
        calc_top_n_ngrams(env, n)

    build_model(env, n)
